<!DOCTYPE html>
<html>

<head>
    <title>Event Page</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script defer src="web-components/mini-window.js"></script>
    <script defer src="web-components/mini-window-closable.js"></script>
    <script defer src="web-components/side-bar-window.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/event.css">
    <link rel="stylesheet" href="css/layout.css">

</head>

<body>
    <nav>
        <ul>
            <li><a href="/">Login</a></li>
            <li><a href="event">Event Page</a></li>
            <li><a href="historical">Historical Data</a></li>
            <li><a href="eventManage">Event Manage</a></li>
        </ul>
    </nav>
    <div class="dropdown-section">
        <label for="eventDropdown">Select Event:</label>
        <select id="eventDropdown">
            <option value="">--Select an Event--</option>
            <!-- Event options will be populated here -->
        </select>
    </div>

    <mini-window-closable id="eventTimes" class="finish-times">
        <h2>Event Finish Times</h2>
        <table id="finishTimesTable">
            <thead>
                <tr>
                    <th>Pilot Name</th>
                </tr>
            </thead>
            <tbody id="finishTimesBody">
                <!-- Pilot names and times will be added here -->
            </tbody>
        </table>
    </mini-window-closable>

    <div class="race-status">
        <h2>Race Status</h2>
        <div id="raceStatusBox">Waiting for race status...</div>
    </div>

    <mini-window-closable id="race-chart" class="race-chart">
        <h2>Race Chart</h2>
        <canvas id="raceChart"></canvas>
    </mini-window-closable>

    <script>
        window.onload = function () {
            var eventHostSocket = io();
            var eventSocket = io();

            var ctx = document.getElementById("raceChart").getContext("2d");
            var raceChart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [],
                },
                options: {
                    plugins: {
                        legend: {
                            labels: {
                                color: "white",
                                font: {
                                    size: 15
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: "white",
                                font: {
                                    size: 15,
                                },
                                stepSize: 1,
                                beginAtZero: true
                            }
                        },
                        x: {
                            ticks: {
                                color: "white",
                                font: {
                                    size: 15
                                },
                                stepSize: 1,
                                beginAtZero: true
                            }
                        }
                    }
                },
            });

            eventHostSocket.on("raceStatus", function (status) {
                var statusBox = document.getElementById("raceStatusBox");
                statusBox.textContent = `Race Status: ${status}`;
                if (status === "start") {
                    raceChart.data.datasets = [];
                }
            });

            eventHostSocket.on("raceDataUpdate", function (data) {
                let dataset = raceChart.data.datasets.find(
                    (ds) => ds.label === data.pilotName
                );
                if (dataset) {
                    dataset.data.push({
                        x:
                            data.gateData[data.gateData.length - 1].lap.toString() +
                            "-" +
                            data.gateData[data.gateData.length - 1].gate.toString(),
                        y: data.gateData[data.gateData.length - 1].time,
                    });

                    dataset.data = dataset.data.sort(function (a, b) { return a.y - b.y; });

                } else {
                    raceChart.data.datasets.push({
                        label: data.pilotName,
                        data: [
                            {
                                x:
                                    data.gateData[data.gateData.length - 1].lap.toString() +
                                    "-" +
                                    data.gateData[data.gateData.length - 1].gate.toString(),
                                y: data.gateData[data.gateData.length - 1].time,
                            },
                        ],
                        borderColor: data.colour,
                        fill: false,
                    });
                }

                raceChart.options.animation = false;

                raceChart.update();
                raceChart.update();

                raceChart.options.animation = {
                    duration: 1000,
                };
            });

            eventSocket.on("pilotFinished", function (data) {
                addTimeToTable({ pilotName: data.pilotName, time: data.time });
            });


            document.getElementById("eventDropdown").addEventListener("focus", function () {
                document.currentEventHost = this.value;
            });

            document.getElementById("eventDropdown").addEventListener("change", function () {
                const selectedEventId = this.value.split("|")[0];
                if (selectedEventId) {
                    fetch("/current-finish-times/" + selectedEventId)
                        .then((response) => response.json())
                        .then(fillTimesTable)
                        .catch((error) => console.error("Error:", error));

                    if (document.currentEventHost != null) {
                        eventHostSocket.emit("leave-room", document.currentEventHost);
                        eventSocket.emit("leave-room", document.currentEventHost.split("|")[0]);
                    }

                    eventHostSocket.emit("join-room", this.value);
                    eventSocket.emit("join-room", selectedEventId);

                    document.currentEventHost = this.value;
                }
            });
        };

        fetch("/current-events")
            .then((response) => response.json())
            .then((events) => {
                const dropdown = document.getElementById("eventDropdown");
                events.forEach((event) => {
                    event.hosts.forEach((host) => {
                        const option = document.createElement("option");
                        option.value = `${event.id}|${host.id}`;
                        option.textContent = `${event.name}: ${host.name}`;
                        dropdown.appendChild(option);
                    });
                });
            })
            .catch((error) => console.error("Error:", error));

        function fillTimesTable(data) {
            const tableBody = document.getElementById("finishTimesBody");

            tableBody.innerHTML = "";
            data.forEach((item, index) => {
                let row = tableBody.insertRow();
                let pilotNameCell = row.insertCell(0);
                pilotNameCell.textContent = item.pilotName;

                item.times.forEach((time) => {
                    let timeCell = row.insertCell();
                    timeCell.textContent = time;
                });

                const tableHead = document.getElementById("finishTimesTable").tHead;
                var columnCount = tableHead.rows[0].cells.length - 1;
                if (columnCount < item.times.length) {
                    for (let i = columnCount + 1; i <= item.times.length; i++) {
                        let newHeader = tableHead.rows[0].insertCell();
                        newHeader.outerHTML = `<th>Race ${i}</th>`;
                    }
                }
            });
        }

        function addTimeToTable(data) {
            var pilotRow = getRowByPilotName(data.pilotName);
            var cell = pilotRow.insertCell();
            cell.textContent = data.time;

            const tableHead = document.getElementById("finishTimesTable").tHead;
            var columnCount = tableHead.rows[0].cells.length - 1;
            if (pilotRow.cells.length > tableHead.rows[0].cells.length) {
                let newHeader = tableHead.rows[0].insertCell();
                newHeader.outerHTML = `<th>Race ${pilotRow.cells.length - 1}</th>`;
            }
        }

        function getRowByPilotName(pilotName) {
            const table = document.getElementById("finishTimesTable");
            const rows = table.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                // Assuming the pilot's name is in the first cell
                const currentPilotName = rows[i].cells[0].textContent;
                if (currentPilotName === pilotName) {
                    return rows[i]; // This is the row you're looking for
                }
            }

            return null; // Return null if no row is found for the given pilot name
        }

    </script>
</body>

</html>